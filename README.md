# Раздел 1. Подсистема.
## Лекция 1. 
### Загрузка windows

#### Пункты 1-3 - это free mode, полный доступ ко всему

1) BIOS - микроконтроллер (248 байт).
        
    - Проверяет компоненты на валидность - watchdog
    - Посылает опросы (такты). Между ними ожидает события. 
    - Прерывание биоса - когда между проверкой процессора/монитора/др он обрабатывает переферийные устройства 
    - После первых 256 такотов BIOS передаёт управление MBR (master boot record)   

2) MBR - всегда первые 512 байт кода на загрузочном диске -выполняется процессором.
    - Первый *загрузочный* сектор.
    - general part (446 байт) - основной код. Находит загрузчики и т.д.
    - partition table (64 байта) - `ОС и её положение в байтах (MBR + 850 байт, например)` - каждая строка по 16 байт => до 4 операционок на диске 
    - signature - сигнатутра (2 байта) всегда `0xAA55`

3) VBR (volume boot record) (510 байт) - работает с адресами на дисках 

    - На Линуксе вместо VBR используется GRUB
    - Сигнатура оканчания: `0xEE55`
    - Первый *активный* сектор.

#### Закончился free mode. Начались защищённые регистры, компоненты грузятся в защищённом сегменте

4) NTLdR (NT loader) -> `NTLdR protection mode`
    - Защита компонентов

5) Drivers

6) Boot loader 

7) Kernel32.sys - ядро винды

8) winload.exe - экран логина, пароля

#### Наиболее уязвимы первые 3 компоненты. (1 и 4 наиболее сложны для модификации)

boot kit - утилита скрытия от уровня подсистемы  (модификация (1-3 компонентов))

прикладная антифорендика - исследование уявимостей ядра и загрузочных компонентов.
```c++ 
// пример модификации MBR на c++
// google: c++ mbr overwrite
createFileA(L"////.//PhysicalDrive0", GET_FILE_POINTER )

HANDLE MasterBootRecord = CreateFileA("\\\\.\\PhysicalDrive0"
		, GENERIC_ALL, FILE_SHARE_READ | FILE_SHARE_WRITE
		, NULL, OPEN_EXISTING, 0, NULL);
```

0x7c00 - сектор, куда процессор подгружает general part MBR

### Загрузка Linux
1) BIOS
2) MBR
3) GRUB (если сигнатура MBR изменилась, grub ругается )
4) SYS_KERNEL - аналог ядра
5) NEThost - экран логина

### У Mac файловая система закрыта, так что неясно, что там.

BIOS->MBR->VBR->???
Буткитов под Mac нет

## Лекция 2. Диски, файловые системы.

1)  **Раздел** (Cluster) - область пространства на жёстком диске. VBR даёт кластерам имена. 
    ``` 
    Например:
    1 - 0x89AA5 [850-5000 байты диска]
    2 - 0xAABCE [5001-10010 байты диска]
    ```
2) Разделы подразделены на **сектора** (blocks). Сектора находятся внутри своего раздела.
    ```
    0x022 - block1 [850-850] 
    ```

По умолчанию операционная система выделяет 12,5% пространства диска под **MFT** (Master File Table). Mft хранит ссылки на все файлы. В Mft вроде как есть "резервный раздел Mft". 
```css
Cluster1{
    Block1[adress,size]
    Block2[adress,size]
}
```
О местонахождении Mft знает только VBR.

## Лекция 3. Процессоры и регистры

**Процессор** - кремниевая плата с логическими цепями и контактными ножками.

Чем больше разрядов - тем больше он может обработать за раз.

Процессор состоит **из 3-х частей:**

### 1. АЛУ (Алгебраическое Логическое Устройство)

В нём описаны все законы Математической Логики (сложение, вычитание, умножение, etc).

1) sub - сложение (пример: ```mov sub(AX, BX), CX``` положит сумму значений регистров AX и BX в CX)
2) mov - кладёт значения
3) xor - булево смещение
4) ...
5) cli - выключает процессор (последний перестаёт что-либо обрабатывать)
6) sti - включает процессор

### 2. Регистры

**Регистр** - объект, в котором можно хранить информацию.

#### 2.1 Свободные регистры

##### Занимающие 2 и 1 байт соответственно:

- AX
  - AH
  - AL
- BX
  - BH
  - BL
- CX
  - CH
  - CL
- DX
  - DH
  - DL
- EX
  - EH
  - EL
- FX
  - FH
  - FL

Те что занимают один байт, фактически являются половинками тех, что покрупнее (возможна неточность).
  
##### Занимающие 4 байта:

- EAX
- EBX
- ECX
- EDX
- EEX
- EFX

Каждых из них тоже делятся на два регистра, как и в случае с 2-мя байтами, но по другой схеме (далее рассматривается на примере EAX):

- EAX
  - AX (тот самый регистр из указанных раннее)
    - AH
    - AL
  - AS (хранит информацию о количестве оставшихся байтов и их местоположении)

##### Занимающие 8 байт

- RAX
- RBX
- etc...

Делятся они схожим образом с 4-х-байтными.

#### 2.2 Сегментные регистры

- AD
- BD
- CD
- DD
- ED
- FD
  
Эти регистры используются ОС и каждый из них занимает 4 байта. Когда инициализируется MBR, он в каждый из них записывает указатель на некоторую область ОЗУ (RAM), уникально для каждой системы (где-то на один регистр приходится 256 Мбайт, а где-то - все 512 Мб). В случае с Windows: после активации защитного режима NTLdR к ним, как к регистрам, доступ имеет только система.

#### 2.3 Индексные регистры

- CHD
- CDL
- CAH
- CHL

Каждый из них имеет только 1 байт и у всех по умолчанию записано 0x00 (полное ничего). После каждого тика они сбрасываются. Нужны они для того, чтобы хранить результат некоторых операций (видеокарта просит "положить" некоторое число в регистр и сообщить о результате в CHD, например).

### 3. Контроллер

**Контроллер** - часть процессора, распределяющая задачи.

### Шина

**Шина** - совакупность пинов

### Как передаются данные

Условно говоря:

```
20 В - ничего не занчит, ничего не читать
10 В - 0
30 В - 1
```

Тогда:

```
20|20|10|10|30|20|10
```

расшифровываются как 010. При этом, нельзя сразу изменять значение из крайности в крайность, иначе процессор может "потеряться" (возможна неточность).