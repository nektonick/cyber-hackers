# Раздел 1. Подсистема.
## Лекция 1. 
### Загрузка windows

#### Пункты 1-3 - это free mode, полный доступ ко всему

1) BIOS - микроконтроллер (248 байт).
        
    - Проверяет компоненты на валидность - watchdog
    - Посылает опросы (такты). Между ними ожидает события. 
    - Прерывание биоса - когда между проверкой процессора/монитора/др он обрабатывает переферийные устройства 
    - После первых 256 такотов BIOS передаёт управление MBR (master boot record)   

2) MBR - всегда первые 512 байт кода на загрузочном диске -выполняется процессором.
    - Первый *загрузочный* сектор.
    - general part (446 байт) - основной код. Находит загрузчики и т.д.
    - partition table (64 байта) - `ОС и её положение в байтах (MBR + 850 байт, например)` - каждая строка по 16 байт => до 4 операционок на диске 
    - signature - сигнатутра (2 байта) всегда `0xAA55`

3) VBR (volume boot record) (510 байт) - работает с адресами на дисках 

    - На Линуксе вместо VBR используется GRUB
    - Сигнатура оканчания: `0xEE55`
    - Первый *активный* сектор.

#### Закончился free mode. Начались защищённые регистры, компоненты грузятся в защищённом сегменте

4) NTLdR (NT loader) -> `NTLdR protection mode`
    - Защита компонентов

5) Drivers

6) Boot loader 

7) Kernel32.sys - ядро винды

8) winload.exe - экран логина, пароля

#### Наиболее уязвимы первые 3 компоненты. (1 и 4 наиболее сложны для модификации)

boot kit - утилита скрытия от уровня подсистемы  (модификация (1-3 компонентов))

прикладная антифорендика - исследование уявимостей ядра и загрузочных компонентов.
```c++ 
// пример модификации MBR на c++
// google: c++ mbr overwrite
createFileA(L"////.//PhysicalDrive0", GET_FILE_POINTER )

HANDLE MasterBootRecord = CreateFileA("\\\\.\\PhysicalDrive0"
		, GENERIC_ALL, FILE_SHARE_READ | FILE_SHARE_WRITE
		, NULL, OPEN_EXISTING, 0, NULL);
```

0x7c00 - сектор, куда процессор подгружает general part MBR

### Загрузка Linux
1) BIOS
2) MBR
3) GRUB (если сигнатура MBR изменилась, grub ругается )
4) SYS_KERNEL - аналог ядра
5) NEThost - экран логина

### У Mac файловая система закрыта, так что неясно, что там.

BIOS->MBR->VBR->???
Буткитов под Mac нет

## Лекция 2. Диски, файловые системы.

1)  **Раздел** (Cluster) - область пространства на жёстком диске. VBR даёт кластерам имена. 
    ``` 
    Например:
    1 - 0x89AA5 [850-5000 байты диска]
    2 - 0xAABCE [5001-10010 байты диска]
    ```
2) Разделы подразделены на **сектора** (blocks). Сектора находятся внутри своего раздела.
    ```
    0x022 - block1 [850-850] 
    ```

По умолчанию операционная система выделяет 12,5% пространства диска под **MFT** (Master File Table). Mft хранит ссылки на все файлы. В Mft вроде как есть "резервный раздел Mft". 
```css
Cluster1{
    Block1[adress,size]
    Block2[adress,size]
}
```
О местонахождении Mft знает только VBR.

## Далее: процессоры и регистры
